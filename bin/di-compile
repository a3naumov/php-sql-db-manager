#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

// di-compile
interface CommandInterface
{
    public const int EXIT_SUCCESS = 0;
    public const int EXIT_FAILURE = 1;

    public function getName(): string;

    public function execute(): int;
}

class DiCompileCommand implements CommandInterface
{
    public function getName(): string
    {
        return 'di-compile';
    }

    public function execute(): int
    {
        $classes = [
            \App\Web\Controller\HomepageController::class,
            \Framework\Core\Config\ConfigProvider::class,
        ];

        $map = [];

        foreach  ($classes as $class) {
            $reflection = new ReflectionClass($class);
            $constructor = $reflection->getConstructor();

            if (!$constructor) {
                $map[$class] = [];
                continue;
            }

            $dependencies = [];
            foreach($constructor->getParameters() as $parameter) {
                $type = $parameter->getType();
                if ($type && !$type->isBuiltin()) {
                    $dependencies[] = $type->getName();
                } else {
                    $dependencies[] = 'mixed';
                }
            }

            $map[$class] = $dependencies;
        }

        file_put_contents(
            __DIR__ . '/../var/di-map.php',
            '<?php return ' . var_export($map, true) . ';'
        );

        return self::EXIT_SUCCESS;
    }
}

exit((new DiCompileCommand())->execute());
